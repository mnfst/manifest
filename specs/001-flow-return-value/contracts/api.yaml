openapi: 3.0.3
info:
  title: Flow Return Value API
  description: API extensions for flow return value support (entity-based model)
  version: 2.0.0

paths:
  /api/flows/{flowId}:
    get:
      summary: Get flow by ID
      description: Returns a flow including its return values (if any)
      operationId: getFlow
      tags:
        - Flows
      parameters:
        - name: flowId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Flow details with return values
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Flow'
        '404':
          description: Flow not found

  /api/flows/{flowId}/return-values:
    get:
      summary: List return values for a flow
      description: Returns all return values for a flow, ordered by position
      operationId: listReturnValues
      tags:
        - Return Values
      parameters:
        - name: flowId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: List of return values
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ReturnValue'
        '404':
          description: Flow not found

    post:
      summary: Create a return value
      description: |
        Creates a new return value for a flow.
        Fails if the flow already has views (mutual exclusivity).
      operationId: createReturnValue
      tags:
        - Return Values
      parameters:
        - name: flowId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/CreateReturnValueRequest'
            examples:
              simple:
                summary: Create a simple return value
                value:
                  text: "The operation completed successfully."
      responses:
        '201':
          description: Return value created
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ReturnValue'
        '400':
          description: Validation error (e.g., flow has views)
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/Error'
              examples:
                mutualExclusivity:
                  summary: Flow has views
                  value:
                    statusCode: 400
                    message: "Cannot add return values to a flow that has views"
                    error: "Bad Request"
        '404':
          description: Flow not found

  /api/flows/{flowId}/return-values/reorder:
    patch:
      summary: Reorder return values
      description: Updates the order of return values for a flow
      operationId: reorderReturnValues
      tags:
        - Return Values
      parameters:
        - name: flowId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/ReorderReturnValuesRequest'
            examples:
              reorder:
                summary: Reorder two return values
                value:
                  orderedIds:
                    - "uuid-of-second-item"
                    - "uuid-of-first-item"
      responses:
        '200':
          description: Return values reordered
          content:
            application/json:
              schema:
                type: array
                items:
                  $ref: '#/components/schemas/ReturnValue'
        '400':
          description: Invalid order (missing or extra IDs)
        '404':
          description: Flow or return value not found

  /api/flows/{flowId}/return-values/{returnValueId}:
    get:
      summary: Get a return value by ID
      description: Returns a single return value
      operationId: getReturnValue
      tags:
        - Return Values
      parameters:
        - name: flowId
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: returnValueId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '200':
          description: Return value details
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ReturnValue'
        '404':
          description: Return value not found

    patch:
      summary: Update a return value
      description: Updates the text content of a return value
      operationId: updateReturnValue
      tags:
        - Return Values
      parameters:
        - name: flowId
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: returnValueId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/UpdateReturnValueRequest'
            examples:
              updateText:
                summary: Update text content
                value:
                  text: "Updated return value content"
      responses:
        '200':
          description: Return value updated
          content:
            application/json:
              schema:
                $ref: '#/components/schemas/ReturnValue'
        '404':
          description: Return value not found

    delete:
      summary: Delete a return value
      description: Deletes a return value from a flow
      operationId: deleteReturnValue
      tags:
        - Return Values
      parameters:
        - name: flowId
          in: path
          required: true
          schema:
            type: string
            format: uuid
        - name: returnValueId
          in: path
          required: true
          schema:
            type: string
            format: uuid
      responses:
        '204':
          description: Return value deleted
        '404':
          description: Return value not found

  /api/apps/{appSlug}/mcp:
    post:
      summary: MCP JSON-RPC endpoint
      description: |
        Handles MCP protocol requests including tools/call.
        When a flow has return values, the tool call returns all values
        as text content items in the response array.
      operationId: mcpJsonRpc
      tags:
        - MCP
      parameters:
        - name: appSlug
          in: path
          required: true
          schema:
            type: string
      requestBody:
        required: true
        content:
          application/json:
            schema:
              $ref: '#/components/schemas/JsonRpcRequest'
            examples:
              toolCall:
                summary: Call a tool with return values
                value:
                  jsonrpc: "2.0"
                  id: 1
                  method: "tools/call"
                  params:
                    name: "get_weather"
                    arguments: {}
      responses:
        '200':
          description: JSON-RPC response
          content:
            application/json:
              schema:
                oneOf:
                  - $ref: '#/components/schemas/McpToolResultResponse'
                  - $ref: '#/components/schemas/McpViewResultResponse'
              examples:
                singleReturnValue:
                  summary: Single return value result
                  value:
                    jsonrpc: "2.0"
                    id: 1
                    result:
                      content:
                        - type: "text"
                          text: "The current temperature is 72°F."
                      isError: false
                multipleReturnValues:
                  summary: Multiple return values result
                  value:
                    jsonrpc: "2.0"
                    id: 1
                    result:
                      content:
                        - type: "text"
                          text: "Current conditions: Partly cloudy"
                        - type: "text"
                          text: "Temperature: 72°F"
                        - type: "text"
                          text: "Humidity: 45%"
                      isError: false
                viewResult:
                  summary: View-based tool result (existing)
                  value:
                    jsonrpc: "2.0"
                    id: 1
                    result:
                      structuredContent:
                        type: "table"
                        columns: []
                        rows: []
                      content:
                        - type: "text"
                          text: "Here is the data:"
                      _meta:
                        openai/outputTemplate: "ui://widget/my-app/my-tool.html"

components:
  schemas:
    ReturnValue:
      type: object
      required:
        - id
        - flowId
        - text
        - order
      properties:
        id:
          type: string
          format: uuid
        flowId:
          type: string
          format: uuid
        text:
          type: string
          description: Text content to return to the LLM
        order:
          type: integer
          description: Position in the return values sequence (0-based)
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    CreateReturnValueRequest:
      type: object
      required:
        - text
      properties:
        text:
          type: string
          description: Text content to return to the LLM

    UpdateReturnValueRequest:
      type: object
      properties:
        text:
          type: string
          description: Updated text content

    ReorderReturnValuesRequest:
      type: object
      required:
        - orderedIds
      properties:
        orderedIds:
          type: array
          items:
            type: string
            format: uuid
          description: Array of return value IDs in the desired order

    Flow:
      type: object
      required:
        - id
        - appId
        - name
        - toolName
        - toolDescription
        - isActive
      properties:
        id:
          type: string
          format: uuid
        appId:
          type: string
          format: uuid
        name:
          type: string
        description:
          type: string
          nullable: true
        toolName:
          type: string
        toolDescription:
          type: string
        whenToUse:
          type: string
          nullable: true
        whenNotToUse:
          type: string
          nullable: true
        isActive:
          type: boolean
        parameters:
          type: array
          items:
            $ref: '#/components/schemas/FlowParameter'
        views:
          type: array
          items:
            $ref: '#/components/schemas/View'
        returnValues:
          type: array
          items:
            $ref: '#/components/schemas/ReturnValue'
          description: Return values for the flow (mutually exclusive with views)
        createdAt:
          type: string
          format: date-time
        updatedAt:
          type: string
          format: date-time

    FlowParameter:
      type: object
      required:
        - name
        - type
        - description
        - optional
      properties:
        name:
          type: string
        type:
          type: string
          enum: [string, number, integer, boolean]
        description:
          type: string
        optional:
          type: boolean

    View:
      type: object
      description: View entity (existing, not modified)

    McpTextContent:
      type: object
      required:
        - type
        - text
      properties:
        type:
          type: string
          enum: [text]
        text:
          type: string

    McpToolResultResponse:
      type: object
      description: MCP tool result for return value flows
      properties:
        jsonrpc:
          type: string
          enum: ["2.0"]
        id:
          type: integer
        result:
          type: object
          properties:
            content:
              type: array
              items:
                $ref: '#/components/schemas/McpTextContent'
            isError:
              type: boolean
              default: false

    McpViewResultResponse:
      type: object
      description: MCP tool result for view-based flows (existing)
      properties:
        jsonrpc:
          type: string
          enum: ["2.0"]
        id:
          type: integer
        result:
          type: object
          properties:
            structuredContent:
              type: object
            content:
              type: array
              items:
                $ref: '#/components/schemas/McpTextContent'
            _meta:
              type: object

    JsonRpcRequest:
      type: object
      required:
        - jsonrpc
        - method
      properties:
        jsonrpc:
          type: string
          enum: ["2.0"]
        id:
          type: integer
        method:
          type: string
        params:
          type: object

    Error:
      type: object
      properties:
        statusCode:
          type: integer
        message:
          type: string
        error:
          type: string
