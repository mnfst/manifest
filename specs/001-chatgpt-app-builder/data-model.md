# Data Model: ChatGPT App Builder

**Branch**: `001-chatgpt-app-builder` | **Date**: 2025-12-22

> **POC Note**: Simplified data model for single-session operation. No persistence between sessions.

## Entity Relationship Diagram

```
┌──────────────────────────────────────────────────────┐
│                        App                           │
├──────────────────────────────────────────────────────┤
│ id (PK)                                              │
│ name                                                 │
│ description                                          │
│ systemPrompt                                         │
│ layoutTemplate                                       │
│ themeVariables (JSON)                                │
│ mockData (JSON)             ← Sample data for layout │
│ toolName                    ← MCP tool configuration │
│ toolDescription                                      │
│ mcpSlug                     ← MCP server identifier  │
│ status                                               │
└──────────────────────────────────────────────────────┘
```

## Entities

### App

Represents a user-created ChatGPT application with integrated MCP server configuration. When published, the app is served at `/servers/{mcpSlug}/mcp`.

| Field | Type | Constraints | Description |
|-------|------|-------------|-------------|
| id | UUID | PK, auto-generated | Unique identifier |
| name | string | required, max 100 chars | Display name (generated by agent) |
| description | string | optional, max 500 chars | Brief description (generated by agent) |
| layoutTemplate | enum | required | Selected layout: 'table' or 'post-list' |
| systemPrompt | string | required | Original user prompt |
| themeVariables | JSON | required | shadcn CSS variable overrides |
| mockData | JSON | required | Sample data matching layout template format |
| toolName | string | required for publish, max 50 | LLM-friendly tool name (e.g., "search_products") |
| toolDescription | string | required for publish, max 500 | Tool description conveying intent to LLMs |
| mcpSlug | string | unique, URL-safe | Derived from app name for MCP endpoint |
| status | enum | required | draft, published |

**Layout Templates (POC)**:
```typescript
type LayoutTemplate = 'table' | 'post-list';

const LAYOUT_REGISTRY = {
  'table': {
    manifestBlock: '@manifest/table',
    installCommand: 'npx shadcn@latest add @manifest/table',
    useCase: 'Tabular data, lists, order history'
  },
  'post-list': {
    manifestBlock: '@manifest/blog-post-list',
    installCommand: 'npx shadcn@latest add @manifest/blog-post-list',
    useCase: 'Content feeds, articles, blog posts'
  }
};
```

**Theme Variables JSON Structure**:
```typescript
interface ThemeVariables {
  // shadcn CSS variable overrides
  '--primary': string;           // e.g., '221.2 83.2% 53.3%'
  '--primary-foreground': string;
  '--background': string;
  '--foreground': string;
  '--muted': string;
  '--muted-foreground': string;
  '--accent': string;
  '--accent-foreground': string;
  // ... other shadcn variables
}
```

**Mock Data JSON Structure** (layout-specific):
```typescript
// Mock data format depends on the selected layout template
type MockData = TableMockData | PostListMockData;

// For 'table' layout - array of row objects
interface TableMockData {
  columns: Array<{
    key: string;
    header: string;
    type: 'text' | 'number' | 'date' | 'badge' | 'action';
  }>;
  rows: Array<Record<string, unknown>>;
}

// Example table mock data (order history):
// {
//   columns: [
//     { key: 'orderId', header: 'Order ID', type: 'text' },
//     { key: 'date', header: 'Date', type: 'date' },
//     { key: 'status', header: 'Status', type: 'badge' },
//     { key: 'total', header: 'Total', type: 'number' }
//   ],
//   rows: [
//     { orderId: 'ORD-001', date: '2025-01-15', status: 'Delivered', total: 129.99 },
//     { orderId: 'ORD-002', date: '2025-01-18', status: 'Processing', total: 89.50 }
//   ]
// }

// For 'post-list' layout - array of post objects
interface PostListMockData {
  posts: Array<{
    id: string;
    title: string;
    excerpt: string;
    author?: string;
    date?: string;
    image?: string;
    category?: string;
    tags?: string[];
  }>;
}

// Example post-list mock data (blog posts):
// {
//   posts: [
//     {
//       id: 'post-1',
//       title: 'Getting Started Guide',
//       excerpt: 'Learn how to set up your account...',
//       author: 'Support Team',
//       date: '2025-01-20',
//       category: 'Tutorial'
//     }
//   ]
// }
```

**Status Transitions** (simplified for POC):
```
draft ──publish──► published
```

**MCP Endpoint Pattern**:
When status is `published`, the app is accessible at:
```
/servers/{mcpSlug}/mcp
```

**UI Component Endpoint**:
```
/servers/{mcpSlug}/ui/{layoutTemplate}.html
```

---

## Validation Rules (POC - minimal)

### Publish Validation

1. **Tool Name**: Required, 1-50 characters
2. **Tool Description**: Required, 10-500 characters
3. **Mock Data**: Required, must match layout template format

---

## TypeORM Entity Definition

```typescript
// packages/backend/src/entities/app.entity.ts
@Entity()
export class App {
  @PrimaryGeneratedColumn('uuid')
  id: string;

  @Column({ length: 100 })
  name: string;

  @Column({ length: 500, nullable: true })
  description: string;

  @Column({
    type: 'varchar',
    length: 20,
    default: 'table'
  })
  layoutTemplate: 'table' | 'post-list';

  @Column('text')
  systemPrompt: string;

  @Column('simple-json')
  themeVariables: ThemeVariables;

  @Column('simple-json')
  mockData: MockData;

  // MCP Tool Configuration
  @Column({ length: 50, nullable: true })
  toolName: string;

  @Column({ length: 500, nullable: true })
  toolDescription: string;

  // MCP Server Configuration
  @Column({ unique: true, nullable: true })
  mcpSlug: string;

  @Column({
    type: 'varchar',
    length: 20,
    default: 'draft'
  })
  status: 'draft' | 'published';
}
```

---

## Shared Types (packages/shared)

```typescript
// packages/shared/src/types/app.ts
export interface App {
  id: string;
  name: string;
  description?: string;
  layoutTemplate: LayoutTemplate;
  systemPrompt: string;
  themeVariables: ThemeVariables;
  mockData: MockData;
  toolName?: string;
  toolDescription?: string;
  mcpSlug?: string;
  status: AppStatus;
}

export type AppStatus = 'draft' | 'published';
export type LayoutTemplate = 'table' | 'post-list';

// packages/shared/src/types/theme.ts
export interface ThemeVariables {
  '--primary': string;
  '--primary-foreground': string;
  '--background': string;
  '--foreground': string;
  '--muted': string;
  '--muted-foreground': string;
  '--accent': string;
  '--accent-foreground': string;
  [key: `--${string}`]: string;  // Allow additional CSS variables
}

// packages/shared/src/types/mock-data.ts
export type MockData = TableMockData | PostListMockData;

export interface TableMockData {
  type: 'table';
  columns: Array<{
    key: string;
    header: string;
    type: 'text' | 'number' | 'date' | 'badge' | 'action';
  }>;
  rows: Array<Record<string, unknown>>;
}

export interface PostListMockData {
  type: 'post-list';
  posts: Array<{
    id: string;
    title: string;
    excerpt: string;
    author?: string;
    date?: string;
    image?: string;
    category?: string;
    tags?: string[];
  }>;
}

// packages/shared/src/types/mcp.ts
export interface McpToolResponse {
  content: Array<{ type: 'text'; text: string }>;
  structuredContent: MockData;
  _meta: {
    'openai/outputTemplate': string;  // e.g., "ui://widget/{mcpSlug}.html"
  };
}

export interface PublishResult {
  endpointUrl: string;  // "/servers/{mcpSlug}/mcp"
  uiUrl: string;        // "/servers/{mcpSlug}/ui/{layoutTemplate}.html"
  app: App;
}
```
