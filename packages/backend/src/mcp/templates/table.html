<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{appName}} - Table View</title>
  <style>
    :root {
      {{themeVariables}}
      --background: 0 0% 100%;
      --foreground: 222.2 84% 4.9%;
      --card: 0 0% 100%;
      --card-foreground: 222.2 84% 4.9%;
      --muted: 210 40% 96.1%;
      --muted-foreground: 215.4 16.3% 46.9%;
      --border: 214.3 31.8% 91.4%;
      --primary: 222.2 47.4% 11.2%;
      --primary-foreground: 210 40% 98%;
    }

    .dark {
      --background: 222.2 84% 4.9%;
      --foreground: 210 40% 98%;
      --card: 222.2 84% 4.9%;
      --card-foreground: 210 40% 98%;
      --muted: 217.2 32.6% 17.5%;
      --muted-foreground: 215 20.2% 65.1%;
      --border: 217.2 32.6% 17.5%;
      --primary: 210 40% 98%;
      --primary-foreground: 222.2 47.4% 11.2%;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: hsl(var(--background));
      color: hsl(var(--foreground));
      font-size: 14px;
      line-height: 1.5;
    }

    .table-container {
      width: 100%;
    }

    /* Mobile: Card view */
    @media (max-width: 639px) {
      table {
        display: none;
      }

      .mobile-cards {
        display: flex;
        flex-direction: column;
        gap: 8px;
      }

      .mobile-card {
        padding: 12px;
        border-radius: 8px;
        border: 1px solid hsl(var(--border));
        background: hsl(var(--card));
      }

      .mobile-card-row {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 6px;
      }

      .mobile-card-row:last-child {
        margin-bottom: 0;
      }

      .mobile-label {
        font-size: 12px;
        color: hsl(var(--muted-foreground));
      }

      .mobile-value {
        font-size: 12px;
        font-weight: 500;
      }
    }

    /* Desktop: Table view */
    @media (min-width: 640px) {
      .mobile-cards {
        display: none;
      }

      table {
        width: 100%;
        border-collapse: collapse;
        border-radius: 8px;
        overflow: hidden;
      }

      thead {
        border-bottom: 1px solid hsl(var(--border));
        background: hsl(var(--muted) / 0.5);
      }

      th {
        color: hsl(var(--muted-foreground));
        font-weight: 500;
        text-align: left;
        padding: 12px;
        font-size: 14px;
        cursor: pointer;
        user-select: none;
      }

      th:hover {
        color: hsl(var(--foreground));
      }

      th.align-right {
        text-align: right;
      }

      th.align-center {
        text-align: center;
      }

      td {
        padding: 12px;
        font-size: 14px;
        border-bottom: 1px solid hsl(var(--border));
      }

      td.align-right {
        text-align: right;
      }

      td.align-center {
        text-align: center;
      }

      tr:last-child td {
        border-bottom: none;
      }

      tbody tr {
        transition: background-color 0.2s;
      }

      tbody tr:hover {
        background: hsl(var(--muted) / 0.3);
      }

      td:first-child {
        font-weight: 500;
      }
    }

    .badge {
      display: inline-block;
      padding: 4px 8px;
      font-size: 12px;
      font-weight: 500;
      border-radius: 9999px;
      background: hsl(var(--primary) / 0.1);
      color: hsl(var(--primary));
    }

    .empty-message {
      padding: 32px;
      text-align: center;
      color: hsl(var(--muted-foreground));
    }

    .sort-icon {
      display: inline-flex;
      margin-left: 4px;
      opacity: 0.3;
    }

    th:hover .sort-icon {
      opacity: 1;
    }

    .sort-icon.active {
      opacity: 1;
    }
  </style>
</head>
<body>
  <div class="table-container">
    <!-- Desktop: Table view -->
    <table id="data-table">
      <thead>
        <tr id="header-row"></tr>
      </thead>
      <tbody id="body-rows"></tbody>
    </table>

    <!-- Mobile: Card view -->
    <div class="mobile-cards" id="mobile-cards"></div>

    <!-- Empty message -->
    <div class="empty-message" id="empty-message" style="display: none;">
      No data available
    </div>
  </div>

  <script>
    let tableData = null;
    let sortConfig = null;

    // Receive data from parent frame (ChatGPT)
    window.addEventListener('message', function(event) {
      const data = event.data;
      if (data && data.structuredContent) {
        tableData = data.structuredContent;
        renderTable();
      }
    });

    function renderTable() {
      if (!tableData || !tableData.columns || !tableData.rows) {
        document.getElementById('empty-message').style.display = 'block';
        return;
      }

      if (tableData.rows.length === 0) {
        document.getElementById('empty-message').style.display = 'block';
        return;
      }

      document.getElementById('empty-message').style.display = 'none';

      let rows = [...tableData.rows];
      if (sortConfig) {
        rows.sort((a, b) => {
          const aVal = a[sortConfig.key];
          const bVal = b[sortConfig.key];
          if (aVal === bVal) return 0;
          let comparison = 0;
          if (typeof aVal === 'number' && typeof bVal === 'number') {
            comparison = aVal - bVal;
          } else {
            comparison = String(aVal).localeCompare(String(bVal));
          }
          return sortConfig.direction === 'asc' ? comparison : -comparison;
        });
      }

      renderDesktopTable(rows);
      renderMobileCards(rows);
    }

    function renderDesktopTable(rows) {
      const headerRow = document.getElementById('header-row');
      const bodyRows = document.getElementById('body-rows');

      // Render headers with sort icons
      headerRow.innerHTML = tableData.columns
        .map(col => {
          const align = col.type === 'number' ? 'align-right' : '';
          const isActive = sortConfig && sortConfig.key === col.key;
          const icon = isActive
            ? (sortConfig.direction === 'asc' ? '↑' : '↓')
            : '↕';
          return `<th class="${align}" onclick="handleSort('${col.key}')">
            ${col.header}
            <span class="sort-icon ${isActive ? 'active' : ''}">${icon}</span>
          </th>`;
        })
        .join('');

      // Render rows
      bodyRows.innerHTML = rows
        .map(row => {
          const cells = tableData.columns
            .map(col => {
              const value = row[col.key] ?? '';
              const align = col.type === 'number' ? 'align-right' : '';
              if (col.type === 'badge') {
                return `<td class="${align}"><span class="badge">${value}</span></td>`;
              }
              if (col.type === 'number' && typeof value === 'number') {
                return `<td class="${align}">${new Intl.NumberFormat('en-US').format(value)}</td>`;
              }
              if (col.type === 'date') {
                return `<td class="${align}">${formatDate(value)}</td>`;
              }
              return `<td class="${align}">${value}</td>`;
            })
            .join('');
          return `<tr>${cells}</tr>`;
        })
        .join('');
    }

    function renderMobileCards(rows) {
      const container = document.getElementById('mobile-cards');

      container.innerHTML = rows
        .map(row => {
          const cardRows = tableData.columns
            .map(col => {
              const value = row[col.key] ?? '';
              let displayValue = value;
              if (col.type === 'number' && typeof value === 'number') {
                displayValue = new Intl.NumberFormat('en-US').format(value);
              } else if (col.type === 'date') {
                displayValue = formatDate(value);
              } else if (col.type === 'badge') {
                displayValue = `<span class="badge">${value}</span>`;
              }
              return `<div class="mobile-card-row">
                <span class="mobile-label">${col.header}</span>
                <span class="mobile-value">${displayValue}</span>
              </div>`;
            })
            .join('');
          return `<div class="mobile-card">${cardRows}</div>`;
        })
        .join('');
    }

    function handleSort(key) {
      if (sortConfig && sortConfig.key === key) {
        if (sortConfig.direction === 'asc') {
          sortConfig = { key, direction: 'desc' };
        } else {
          sortConfig = null;
        }
      } else {
        sortConfig = { key, direction: 'asc' };
      }
      renderTable();
    }

    function formatDate(value) {
      if (!value) return '';
      try {
        return new Date(value).toLocaleDateString('en-US', {
          month: 'short',
          day: 'numeric',
          year: 'numeric'
        });
      } catch {
        return value;
      }
    }
  </script>
</body>
</html>
