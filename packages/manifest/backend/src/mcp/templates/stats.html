<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>{{appName}} - Stats View</title>
  <style>
    :root {
      {{themeVariables}}
      --background: 0 0% 100%;
      --foreground: 222.2 84% 4.9%;
      --card: 0 0% 100%;
      --card-foreground: 222.2 84% 4.9%;
      --muted: 210 40% 96.1%;
      --muted-foreground: 215.4 16.3% 46.9%;
      --border: 214.3 31.8% 91.4%;
      --primary: 222.2 47.4% 11.2%;
      --primary-foreground: 210 40% 98%;
      --success: 142.1 76.2% 36.3%;
      --destructive: 0 84.2% 60.2%;
    }

    .dark {
      --background: 222.2 84% 4.9%;
      --foreground: 210 40% 98%;
      --card: 222.2 84% 4.9%;
      --card-foreground: 210 40% 98%;
      --muted: 217.2 32.6% 17.5%;
      --muted-foreground: 215 20.2% 65.1%;
      --border: 217.2 32.6% 17.5%;
      --primary: 210 40% 98%;
      --primary-foreground: 222.2 47.4% 11.2%;
      --success: 142.1 70.6% 45.3%;
      --destructive: 0 62.8% 50.6%;
    }

    * {
      margin: 0;
      padding: 0;
      box-sizing: border-box;
    }

    body {
      font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, sans-serif;
      background: hsl(var(--background));
      color: hsl(var(--foreground));
      font-size: 14px;
      line-height: 1.5;
    }

    .stats-container {
      width: 100%;
      padding: 16px;
    }

    .stats-grid {
      display: grid;
      grid-template-columns: repeat(2, 1fr);
      gap: 16px;
    }

    @media (min-width: 768px) {
      .stats-grid {
        grid-template-columns: repeat(3, 1fr);
      }
    }

    .stat-card {
      padding: 16px;
      border-radius: 8px;
      border: 1px solid hsl(var(--border));
      background: hsl(var(--card));
    }

    .stat-label {
      font-size: 12px;
      font-weight: 500;
      color: hsl(var(--muted-foreground));
      text-transform: uppercase;
      letter-spacing: 0.05em;
      margin-bottom: 4px;
    }

    .stat-value {
      font-size: 24px;
      font-weight: 600;
      color: hsl(var(--card-foreground));
      margin-bottom: 4px;
    }

    @media (min-width: 768px) {
      .stat-value {
        font-size: 28px;
      }
    }

    .stat-change {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 12px;
      font-weight: 500;
    }

    .stat-change.up {
      color: hsl(var(--success));
    }

    .stat-change.down {
      color: hsl(var(--destructive));
    }

    .stat-change.neutral {
      color: hsl(var(--muted-foreground));
    }

    .trend-icon {
      width: 16px;
      height: 16px;
    }

    .change-label {
      font-size: 11px;
      color: hsl(var(--muted-foreground));
      margin-left: 4px;
    }

    .empty-message {
      padding: 32px;
      text-align: center;
      color: hsl(var(--muted-foreground));
    }
  </style>
</head>
<body>
  <div class="stats-container">
    <div class="stats-grid" id="stats-grid"></div>
    <div class="empty-message" id="empty-message" style="display: none;">
      No statistics available
    </div>
  </div>

  <script>
    // SVG icons for trend indicators
    const icons = {
      up: '<svg class="trend-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 6 13.5 15.5 8.5 10.5 1 18"></polyline><polyline points="17 6 23 6 23 12"></polyline></svg>',
      down: '<svg class="trend-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><polyline points="23 18 13.5 8.5 8.5 13.5 1 6"></polyline><polyline points="17 18 23 18 23 12"></polyline></svg>',
      neutral: '<svg class="trend-icon" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><line x1="5" y1="12" x2="19" y2="12"></line></svg>'
    };

    // Receive data from parent frame (ChatGPT)
    window.addEventListener('message', function(event) {
      // Only accept messages from the parent frame to reduce XSS risk
      if (event.source !== window.parent) {
        return;
      }
      const data = event.data;
      if (data && data.structuredContent) {
        renderStats(data.structuredContent);
      }
    });

    function renderStats(data) {
      const grid = document.getElementById('stats-grid');
      const emptyMessage = document.getElementById('empty-message');

      if (!data || !data.stats || data.stats.length === 0) {
        grid.style.display = 'none';
        emptyMessage.style.display = 'block';
        return;
      }

      grid.style.display = 'grid';
      emptyMessage.style.display = 'none';

      grid.innerHTML = data.stats.map(stat => {
        const trend = stat.trend || determineTrend(stat.change);
        const allowedTrends = ['up', 'down', 'neutral'];
        const safeTrend = allowedTrends.includes(trend) ? trend : 'neutral';
        const changeValue = stat.change !== undefined ? formatChange(stat.change) : '';
        const changeLabel = stat.changeLabel || '';

        return `
          <div class="stat-card">
            <div class="stat-label">${escapeHtml(stat.label)}</div>
            <div class="stat-value">${escapeHtml(String(stat.value))}</div>
            ${changeValue ? `
              <div class="stat-change ${safeTrend}">
                ${icons[safeTrend]}
                <span>${changeValue}</span>
                ${changeLabel ? `<span class="change-label">${escapeHtml(changeLabel)}</span>` : ''}
              </div>
            ` : ''}
          </div>
        `;
      }).join('');
    }

    function determineTrend(change) {
      if (change === undefined || change === null || change === 0) return 'neutral';
      return change > 0 ? 'up' : 'down';
    }

    function formatChange(change) {
      if (change === undefined || change === null) return '';
      const sign = change > 0 ? '+' : '';
      return `${sign}${change.toFixed(1)}%`;
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }
  </script>
</body>
</html>
